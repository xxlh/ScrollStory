/*
 * storyscroll v3.7.0
 * (c) 2020 Little Linghuan & Esone
 * Released under the GPL license
 * ieexx.com
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("pixi.js")):"function"==typeof define&&define.amd?define(["pixi.js"],e):(t=t||self).StoryScroll=e(t.PIXI)}(this,function(l){"use strict";function u(t){return(u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function n(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function r(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function o(e,t){var i,o=Object.keys(e);return Object.getOwnPropertySymbols&&(i=Object.getOwnPropertySymbols(e),t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),o.push.apply(o,i)),o}function s(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?o(Object(i),!0).forEach(function(t){r(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):o(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}var e,m,v,i,c,t=navigator.userAgent,a=(t.indexOf("Trident"),t.indexOf("Presto"),t.indexOf("AppleWebKit"),-1<t.indexOf("Gecko")&&t.indexOf("KHTML"),t.match(/AppleWebKit.*Mobile.*/),t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),-1<t.indexOf("Android")||t.indexOf("Adr"),t.indexOf("iPhone"),t.indexOf("iPad"),t.indexOf("Safari"),-1<t.indexOf("MicroMessenger")),_=-1<t.indexOf("Weibo");t.match(/\sQQ/i);e=window,m=Date.now||function(){return+new Date},v={},i=1,e.core?core.effect||(core.effect={}):e.core={effect:{}},core.effect.Animate={requestAnimationFrame:function(){var i=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame,t=!!i;if(i&&!/requestAnimationFrame\(\)\s*\{\s*\[native code\]\s*\}/i.test(i.toString())&&(t=!1),t)return function(t,e){i(t,e)};var o={},n=1,r=null,s=+new Date;return function(t,e){var i=n++;return o[i]=t,null===r&&(r=setInterval(function(){var t,e=+new Date,i=o;for(t in o={},i)i.hasOwnProperty(t)&&(i[t](e),s=e);2500<e-s&&(clearInterval(r),r=null)},1e3/60)),i}}(),stop:function(t){var e=null!=v[t];return e&&(v[t]=null),e},isRunning:function(t){return null!=v[t]},start:function(r,s,l,c,a,_){var h=m(),p=h,u=0,d=0,f=i++;if(_=_||document.body,f%20==0){var t,e={};for(t in v)e[t]=!0;v=e}function g(t){var e=!0!==t,i=m();if(!v[f]||s&&!s(f))return v[f]=null,void(l&&l(60-d/((i-h)/1e3),f,!1));if(e)for(var o=Math.round((i-p)/(1e3/60))-1,n=0;n<Math.min(o,4);n++)g(!0),d++;c&&1<(u=(i-h)/c)&&(u=1),t=a?a(u):u,!1!==r(t,i,e)&&1!==u||!e?e&&(p=i,core.effect.Animate.requestAnimationFrame(g,_)):(v[f]=null,l&&l(60-d/((i-h)/1e3),f,1===u||null==c))}return v[f]=!0,core.effect.Animate.requestAnimationFrame(g,_),f}},function(){function o(){}function p(t){return Math.pow(t-1,3)+1}function u(t){return(t/=.5)<1?.5*Math.pow(t,3):.5*(Math.pow(t-2,3)+2)}var t,e={__isSingleTouch:!(c=function(t,e){for(var i in this.__callback=t,this.options={scrollingX:!0,scrollingY:!0,animating:!0,animationDuration:250,bouncing:!0,locking:!0,paging:!1,snapping:!1,zooming:!1,minZoom:.5,maxZoom:3,speedMultiplier:1,scrollingComplete:o,penetrationDeceleration:.03,penetrationAcceleration:.08},e)this.options[i]=e[i]}),__isTracking:!1,__didDecelerationComplete:!1,__isGesturing:!1,__isDragging:!1,__isDecelerating:!1,__isAnimating:!1,__clientLeft:0,__clientTop:0,__clientWidth:0,__clientHeight:0,__contentWidth:0,__contentHeight:0,__snapWidth:100,__snapHeight:100,__refreshHeight:null,__refreshActive:!1,__refreshActivate:null,__refreshDeactivate:null,__refreshStart:null,__zoomLevel:1,__scrollLeft:0,__scrollTop:0,__maxScrollLeft:0,__maxScrollTop:0,__scheduledLeft:0,__scheduledTop:0,__scheduledZoom:0,__lastTouchLeft:null,__lastTouchTop:null,__lastTouchMove:null,__positions:null,__minDecelerationScrollLeft:null,__minDecelerationScrollTop:null,__maxDecelerationScrollLeft:null,__maxDecelerationScrollTop:null,__decelerationVelocityX:null,__decelerationVelocityY:null,setDimensions:function(t,e,i,o){var n=this;t===+t&&(n.__clientWidth=t),e===+e&&(n.__clientHeight=e),i===+i&&(n.__contentWidth=i),o===+o&&(n.__contentHeight=o),n.__computeScrollMax(),n.scrollTo(n.__scrollLeft,n.__scrollTop,!0)},setPosition:function(t,e){this.__clientLeft=t||0,this.__clientTop=e||0},setSnapSize:function(t,e){this.__snapWidth=t,this.__snapHeight=e},activatePullToRefresh:function(t,e,i,o){this.__refreshHeight=t,this.__refreshActivate=e,this.__refreshDeactivate=i,this.__refreshStart=o},triggerPullToRefresh:function(){this.__publish(this.__scrollLeft,-this.__refreshHeight,this.__zoomLevel,!0),this.__refreshStart&&this.__refreshStart()},finishPullToRefresh:function(){var t=this;t.__refreshActive=!1,t.__refreshDeactivate&&t.__refreshDeactivate(),t.scrollTo(t.__scrollLeft,t.__scrollTop,!0)},getValues:function(){return{left:this.__scrollLeft,top:this.__scrollTop,zoom:this.__zoomLevel}},getScrollMax:function(){return{left:this.__maxScrollLeft,top:this.__maxScrollTop}},zoomTo:function(t,e,i,o,n){var r=this;if(!r.options.zooming)throw new Error("Zooming is not enabled!");n&&(r.__zoomComplete=n),r.__isDecelerating&&(core.effect.Animate.stop(r.__isDecelerating),r.__isDecelerating=!1);n=r.__zoomLevel;null==i&&(i=r.__clientWidth/2),null==o&&(o=r.__clientHeight/2),t=Math.max(Math.min(t,r.options.maxZoom),r.options.minZoom),r.__computeScrollMax(t);i=(i+r.__scrollLeft)*t/n-i,o=(o+r.__scrollTop)*t/n-o;i>r.__maxScrollLeft?i=r.__maxScrollLeft:i<0&&(i=0),o>r.__maxScrollTop?o=r.__maxScrollTop:o<0&&(o=0),r.__publish(i,o,t,e)},zoomBy:function(t,e,i,o,n){this.zoomTo(this.__zoomLevel*t,e,i,o,n)},scrollTo:function(t,e,i,o){var n=this;if(n.__isDecelerating&&(core.effect.Animate.stop(n.__isDecelerating),n.__isDecelerating=!1),null!=o&&o!==n.__zoomLevel){if(!n.options.zooming)throw new Error("Zooming is not enabled!");t*=o,e*=o,n.__computeScrollMax(o)}else o=n.__zoomLevel;n.options.scrollingX?n.options.paging?t=Math.round(t/n.__clientWidth)*n.__clientWidth:n.options.snapping&&(t=Math.round(t/n.__snapWidth)*n.__snapWidth):t=n.__scrollLeft,n.options.scrollingY?n.options.paging?e=Math.round(e/n.__clientHeight)*n.__clientHeight:n.options.snapping&&(e=Math.round(e/n.__snapHeight)*n.__snapHeight):e=n.__scrollTop,t=Math.max(Math.min(n.__maxScrollLeft,t),0),e=Math.max(Math.min(n.__maxScrollTop,e),0),t===n.__scrollLeft&&e===n.__scrollTop&&(i=!1),n.__isTracking||n.__publish(t,e,o,i)},scrollBy:function(t,e,i){var o=this,n=o.__isAnimating?o.__scheduledLeft:o.__scrollLeft,r=o.__isAnimating?o.__scheduledTop:o.__scrollTop;o.scrollTo(n+(t||0),r+(e||0),i)},doMouseZoom:function(t,e,i,o){t=0<t?.97:1.03;return this.zoomTo(this.__zoomLevel*t,!1,i-this.__clientLeft,o-this.__clientTop)},doTouchStart:function(t,e){if(null==t.length)throw new Error("Invalid touch list: "+t);if(e instanceof Date&&(e=e.valueOf()),"number"!=typeof e)throw new Error("Invalid timestamp value: "+e);var i,o=this;o.__interruptedAnimation=!0,o.__isDecelerating&&(core.effect.Animate.stop(o.__isDecelerating),o.__isDecelerating=!1,o.__interruptedAnimation=!0),o.__isAnimating&&(core.effect.Animate.stop(o.__isAnimating),o.__isAnimating=!1,o.__interruptedAnimation=!0);var n=1===t.length,t=n?(i=t[0].pageX,t[0].pageY):(i=Math.abs(t[0].pageX+t[1].pageX)/2,Math.abs(t[0].pageY+t[1].pageY)/2);o.__initialTouchLeft=i,o.__initialTouchTop=t,o.__zoomLevelStart=o.__zoomLevel,o.__lastTouchLeft=i,o.__lastTouchTop=t,o.__lastTouchMove=e,o.__lastScale=1,o.__enableScrollX=!n&&o.options.scrollingX,o.__enableScrollY=!n&&o.options.scrollingY,o.__isTracking=!0,o.__didDecelerationComplete=!1,o.__isDragging=!n,o.__isSingleTouch=n,o.__positions=[]},doTouchMove:function(t,e,i){if(null==t.length)throw new Error("Invalid touch list: "+t);if(e instanceof Date&&(e=e.valueOf()),"number"!=typeof e)throw new Error("Invalid timestamp value: "+e);var o,n,r,s,l,c,a,_,h,p,u=this;u.__isTracking&&(n=2===t.length?(o=Math.abs(t[0].pageX+t[1].pageX)/2,Math.abs(t[0].pageY+t[1].pageY)/2):(o=t[0].pageX,t[0].pageY),r=u.__positions,u.__isDragging?(s=o-u.__lastTouchLeft,l=n-u.__lastTouchTop,_=u.__scrollLeft,h=u.__scrollTop,p=u.__zoomLevel,null!=i&&u.options.zooming&&(p=(c=p)/u.__lastScale*i,c!==(p=Math.max(Math.min(p,u.options.maxZoom),u.options.minZoom))&&(_=((t=o-u.__clientLeft)+_)*p/c-t,h=((t=n-u.__clientTop)+h)*p/c-t,u.__computeScrollMax(p))),u.__enableScrollX&&(_-=s*this.options.speedMultiplier,((a=u.__maxScrollLeft)<_||_<0)&&(u.options.bouncing?_+=s/2*this.options.speedMultiplier:_=a<_?a:0)),u.__enableScrollY&&(h-=l*this.options.speedMultiplier,((a=u.__maxScrollTop)<h||h<0)&&(u.options.bouncing?(h+=l/2*this.options.speedMultiplier,u.__enableScrollX||null==u.__refreshHeight||(!u.__refreshActive&&h<=-u.__refreshHeight?(u.__refreshActive=!0,u.__refreshActivate&&u.__refreshActivate()):u.__refreshActive&&h>-u.__refreshHeight&&(u.__refreshActive=!1,u.__refreshDeactivate&&u.__refreshDeactivate()))):h=a<h?a:0)),60<r.length&&r.splice(0,30),r.push(_,h,e),u.__publish(_,h,p)):(_=u.options.locking?3:0,h=Math.abs(o-u.__initialTouchLeft),p=Math.abs(n-u.__initialTouchTop),u.__enableScrollX=u.options.scrollingX&&_<=h,u.__enableScrollY=u.options.scrollingY&&_<=p,r.push(u.__scrollLeft,u.__scrollTop,e),u.__isDragging=(u.__enableScrollX||u.__enableScrollY)&&(5<=h||5<=p),u.__isDragging&&(u.__interruptedAnimation=!1)),u.__lastTouchLeft=o,u.__lastTouchTop=n,u.__lastTouchMove=e,u.__lastScale=i)},doTouchEnd:function(t){if(t instanceof Date&&(t=t.valueOf()),"number"!=typeof t)throw new Error("Invalid timestamp value: "+t);var e=this;if(e.__isTracking){if(e.__isTracking=!1,e.__isDragging)if(e.__isDragging=!1,e.__isSingleTouch&&e.options.animating&&t-e.__lastTouchMove<=100){for(var i,o,n=e.__positions,r=n.length-1,s=r,l=r;0<l&&n[l]>e.__lastTouchMove-100;l-=3)s=l;s!==r?(o=n[r]-n[s],i=e.__scrollLeft-n[s-2],r=e.__scrollTop-n[s-1],e.__decelerationVelocityX=i/o*(1e3/60),e.__decelerationVelocityY=r/o*(1e3/60),o=e.options.paging||e.options.snapping?4:1,Math.abs(e.__decelerationVelocityX)>o||Math.abs(e.__decelerationVelocityY)>o?e.__refreshActive||e.__startDeceleration(t):e.options.scrollingComplete()):e.options.scrollingComplete()}else 100<t-e.__lastTouchMove&&e.options.scrollingComplete();e.__isDecelerating||(e.__refreshActive&&e.__refreshStart?(e.__publish(e.__scrollLeft,-e.__refreshHeight,e.__zoomLevel,!0),e.__refreshStart&&e.__refreshStart()):((e.__interruptedAnimation||e.__isDragging)&&e.options.scrollingComplete(),e.scrollTo(e.__scrollLeft,e.__scrollTop,!0,e.__zoomLevel),e.__refreshActive&&(e.__refreshActive=!1,e.__refreshDeactivate&&e.__refreshDeactivate()))),e.__positions.length=0}},__publish:function(t,e,i,o){var n,r,s,l,c,a,_=this,h=_.__isAnimating;h&&(core.effect.Animate.stop(h),_.__isAnimating=!1),o&&_.options.animating?(_.__scheduledLeft=t,_.__scheduledTop=e,_.__scheduledZoom=i,n=_.__scrollLeft,r=_.__scrollTop,s=_.__zoomLevel,l=t-n,c=e-r,a=i-s,_.__isAnimating=core.effect.Animate.start(function(t,e,i){i&&(_.__scrollLeft=n+l*t,_.__scrollTop=r+c*t,_.__zoomLevel=s+a*t,_.__callback&&_.__callback(_.__scrollLeft,_.__scrollTop,_.__zoomLevel))},function(t){return _.__isAnimating===t},function(t,e,i){e===_.__isAnimating&&(_.__isAnimating=!1),(_.__didDecelerationComplete||i)&&_.options.scrollingComplete(),_.options.zooming&&(_.__computeScrollMax(),_.__zoomComplete&&(_.__zoomComplete(),_.__zoomComplete=null))},_.options.animationDuration,h?p:u)):(_.__scheduledLeft=_.__scrollLeft=t,_.__scheduledTop=_.__scrollTop=e,_.__scheduledZoom=_.__zoomLevel=i,_.__callback&&_.__callback(t,e,i),_.options.zooming&&(_.__computeScrollMax(),_.__zoomComplete&&(_.__zoomComplete(),_.__zoomComplete=null)))},__computeScrollMax:function(t){var e=this;null==t&&(t=e.__zoomLevel),e.__maxScrollLeft=Math.max(e.__contentWidth*t-e.__clientWidth,0),e.__maxScrollTop=Math.max(e.__contentHeight*t-e.__clientHeight,0)},__startDeceleration:function(t){var e,i,o,n,r=this;r.options.paging?(e=Math.max(Math.min(r.__scrollLeft,r.__maxScrollLeft),0),i=Math.max(Math.min(r.__scrollTop,r.__maxScrollTop),0),o=r.__clientWidth,n=r.__clientHeight,r.__minDecelerationScrollLeft=Math.floor(e/o)*o,r.__minDecelerationScrollTop=Math.floor(i/n)*n,r.__maxDecelerationScrollLeft=Math.ceil(e/o)*o,r.__maxDecelerationScrollTop=Math.ceil(i/n)*n):(r.__minDecelerationScrollLeft=0,r.__minDecelerationScrollTop=0,r.__maxDecelerationScrollLeft=r.__maxScrollLeft,r.__maxDecelerationScrollTop=r.__maxScrollTop);var s=r.options.snapping?4:.001;r.__isDecelerating=core.effect.Animate.start(function(t,e,i){r.__stepThroughDeceleration(i)},function(){var t=Math.abs(r.__decelerationVelocityX)>=s||Math.abs(r.__decelerationVelocityY)>=s;return t||(r.__didDecelerationComplete=!0),t},function(t,e,i){r.__isDecelerating=!1,r.__didDecelerationComplete&&r.options.scrollingComplete(),r.scrollTo(r.__scrollLeft,r.__scrollTop,r.options.snapping)})},__stepThroughDeceleration:function(t){var e,i,o,n=this,r=n.__scrollLeft+n.__decelerationVelocityX,s=n.__scrollTop+n.__decelerationVelocityY;n.options.bouncing||((i=Math.max(Math.min(n.__maxDecelerationScrollLeft,r),n.__minDecelerationScrollLeft))!==r&&(r=i,n.__decelerationVelocityX=0),(o=Math.max(Math.min(n.__maxDecelerationScrollTop,s),n.__minDecelerationScrollTop))!==s&&(s=o,n.__decelerationVelocityY=0)),t?n.__publish(r,s,n.__zoomLevel):(n.__scrollLeft=r,n.__scrollTop=s),n.options.paging||(n.__decelerationVelocityX*=.95,n.__decelerationVelocityY*=.95),n.options.bouncing&&(i=e=0,o=n.options.penetrationDeceleration,t=n.options.penetrationAcceleration,r<n.__minDecelerationScrollLeft?e=n.__minDecelerationScrollLeft-r:r>n.__maxDecelerationScrollLeft&&(e=n.__maxDecelerationScrollLeft-r),s<n.__minDecelerationScrollTop?i=n.__minDecelerationScrollTop-s:s>n.__maxDecelerationScrollTop&&(i=n.__maxDecelerationScrollTop-s),0!==e&&(e*n.__decelerationVelocityX<=0?n.__decelerationVelocityX+=e*o:n.__decelerationVelocityX=e*t),0!==i&&(i*n.__decelerationVelocityY<=0?n.__decelerationVelocityY+=i*o:n.__decelerationVelocityY=i*t))}};for(t in e)c.prototype[t]=e[t]}();var h=c;return function(){function e(t){!function(t){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this),r(this,"STAGE_BOUNDARY",3),r(this,"designWidth",void 0),r(this,"designLength",void 0),r(this,"contentWidth",void 0),r(this,"contentLength",void 0),r(this,"viewWidth",void 0),r(this,"viewLength",void 0),r(this,"deviceWidth",void 0),r(this,"deviceHeight",void 0),r(this,"maxScroll",1e4),r(this,"storyPosition",0),r(this,"prevPool",[]),r(this,"stagePool",[]),r(this,"stagePoolByLen",[]),r(this,"stageZIndexes",{}),r(this,"nextPool",[]),r(this,"currentZIndex",0),this._defaultSetting(t||{}),this._createContainer(t),this._windowResize(),window.addEventListener("resize",this._windowResize.bind(this),!1)}var t,i,o;return t=e,(i=[{key:"chapter",value:function(t,e){var i=new l.Container;return this._setProps(i,t),this._setChapterChildren(i),this._setActions(i),this._ship(i,e),i}},{key:"sprite",value:function(t,e,i){var o=this._createSprite(t);return this._setProps(o,e),this._setActions(o),this._ship(o,i),o}},{key:"spriteAnimated",value:function(t,e,i,o){t=this._createAnimatedSprite(t,i);return this._setProps(t,e),this._setActions(t),this._ship(t,o),!1!==i&&t.play(),t}},{key:"graphic",value:function(t,e){var i=new l.Graphics;return this._setProps(i,t),this._setActions(i),this._ship(i,e),i}},{key:"text",value:function(t,e,i,o){var n=new l.TextStyle;this._setProps(n,i);var r=new l.Text(t,n);return this._setProps(r,e),this._setActions(r),this._ship(r,o),r}},{key:"actionByStep",value:function(t,e,i,o){void 0===o&&(o=this._getSpriteTriggerPosition(t)),t.actions||(t.actions={});var n=this._createHash(8);return t.actions[n]={action:{type:"section",props:e,section:i,triggerPosition:o}},this.sectionActions.push(s({sprite:t,hash:n},t.actions[n].action)),t}},{key:"setPin",value:function(t,e,i){t.actions||(t.actions={}),i=i||this.maxScroll+this.viewLength-t[this.scrollDirection],t.pinSection=i;var o=this._createHash(8);return t.actions[o]={action:{type:"pin",section:i,triggerPosition:e}},this.pinActions.push(s({sprite:t,hash:o},t.actions[o].action)),t}},{key:"stop",value:function(){this.scroller.options.scrollingX=!1,this.scroller.options.scrollingY=!1}},{key:"play",value:function(){this.scroller.options.scrollingX=!0,this.scroller.options.scrollingY=!0}},{key:"_scrollerCallback",value:function(t,e,i){var o=this,n=this;function r(){var t,i=this;0!=this.nextPool.length&&this.nextPool[0][this.scrollDirection]<this.storyPosition+this.viewLength+(this.STAGE_BOUNDARY-1)/2*this.viewLength&&(t=this.nextPool.shift(),this.containerScroll.addChild(t),this.stageZIndexes[t.zIndex]=!0,this.stagePool.push(t),this.stagePoolByLen.push(t),this.stagePoolByLen.sort(function(t,e){return t[i.scrollDirection]+t[i.scrollDirection?"width":"height"]-(e[i.scrollDirection]+e[i.scrollDirection?"width":"height"])}),h(t),r.call(this))}function s(){var t;!function t(e){if(0==e.length)return;if(p(e[0]))return;e.shift();t(e)}(this.stagePoolByLen),0!=this.stagePoolByLen.length&&this.stagePoolByLen[0][this.scrollDirection]+a(this.stagePoolByLen[0])<this.storyPosition-(this.STAGE_BOUNDARY-1)/2*this.viewLength&&(t=this.stagePoolByLen.shift(),this.containerScroll.removeChild(t),delete this.stageZIndexes[t.zIndex],this.prevPool.push(t),_(t),s.call(this))}function l(){var t,i=this;0!=this.prevPool.length&&this.prevPool[this.prevPool.length-1][this.scrollDirection]+a(this.prevPool[this.prevPool.length-1])>this.storyPosition-(this.STAGE_BOUNDARY-1)/2*this.viewLength&&(t=this.prevPool.pop(),this.containerScroll.addChild(t),this.stageZIndexes[t.zIndex]=!0,this.stagePoolByLen.unshift(t),this.stagePool.unshift(t),this.stagePool.sort(function(t,e){return t[i.scrollDirection]-e[i.scrollDirection]}),h(t),l.call(this))}function c(){var t;!function t(e){if(0==e.length)return;if(p(e[e.length-1]))return;e.shift();t(e)}(this.stagePool),0!=this.stagePool.length&&this.stagePool[this.stagePool.length-1][this.scrollDirection]>this.storyPosition+this.viewLength+(this.STAGE_BOUNDARY-1)/2*this.viewLength&&(t=this.stagePool.pop(),this.containerScroll.removeChild(t),delete this.stageZIndexes[t.zIndex],this.nextPool.unshift(t),_(t),c.call(this))}function a(t){var e=t[n.scrollDirection?"width":"height"];return t.pinSection&&(e+=t.pinSection),e}function _(t){t.tweens&&t.tweens.forEach(function(t){t.pausedAtLeaving=t.paused(),t.pausedAtLeaving||t.pause()})}function h(t){t.tweens&&t.tweens.forEach(function(t){t.pausedAtLeaving||t.play()})}function p(t){return!!n.stageZIndexes[t.zIndex]}this.scrollPosition=this._getSrollPosition(t,e),this.storyPosition=this.scrollPosition/this._scale,"y"==this.scrollDirection?this.containerScroll.y=-this.storyPosition:this.containerScroll.x=-this.storyPosition,r.call(this),s.call(this),l.call(this),c.call(this),this.sectionActions.forEach(function(t){(function(t){if(t.sprite._destroyed)return;if(!p(t.sprite))return;var e=t.sprite.actions[t.hash];t.triggerPosition<=this.storyPosition&&this.storyPosition<t.triggerPosition+t.section?i("during",e,t,this.storyPosition):this.storyPosition>=t.triggerPosition+t.section?i("after",e,t,this.storyPosition):this.storyPosition<t.triggerPosition&&i("before",e,t,this.storyPosition);function s(t,e,i,o,n){return o+(i-t)/(e-t)*(n-o)}function i(t,e,i,o){for(var n in t=t||"before",e.originProps=e.originProps||{},i.props)if("object"==u(i.props[n]))for(var r in i.props[n])void 0===e.originProps[n]&&(e.originProps[n]={}),void 0===e.originProps[n][r]&&(e.originProps[n][r]=i.sprite[n][r]),i.sprite[n][r]="before"==t?e.originProps[n][r]:"after"==t?i.props[n][r]:s(i.triggerPosition,i.triggerPosition+i.section,o,e.originProps[n][r],i.props[n][r]);else void 0===e.originProps[n]&&(e.originProps[n]=i.sprite[n]),i.sprite[n]="before"==t?e.originProps[n]:"after"==t?i.props[n]:s(i.triggerPosition,i.triggerPosition+i.section,o,e.originProps[n],i.props[n])}}).call(o,t)}),this.pinActions.forEach(function(t){(function(t){if(t.sprite._destroyed)return;if(!p(t.sprite))return;var e=t.sprite.actions[t.hash];e.originProps=e.originProps||{},void 0===e.originProps[this.scrollDirection]&&(e.originProps[this.scrollDirection]=t.sprite[this.scrollDirection]);t.sprite[this.scrollDirection]=e.originProps[this.scrollDirection]-t.triggerPosition+this.storyPosition}).call(o,t)}),this.debug&&("all"==this.debug&&(console.log("top:",e),console.log("left:",t)),console.log("scrollPosition :",this.scrollPosition))}},{key:"_defaultSetting",value:function(t){var o=this;this.scrollDirection=t.direction||"y",this.designWidth=t.width||750,this.designLength=t.length||1e4,this.containerSelector=t.container,this.backgroundColor=t.bgcolor,this.useLoader=t.loader||!1,this.actionDelaysOnLoaded=t.delay||500,this.loaded=!1,this.progressive=t.progressive||!1,this.antialias=t.antialias||!1,this.debug=t.debug||!1,this._clientWidth=window.innerWidth||document.documentElement.clientWidth,this._clientHeight=window.innerHeight||document.documentElement.clientHeight,this.designOrientation="y"==this.scrollDirection?"portrait":"landscape",this.pinActions=[],this.sectionActions=[],this.loaderList=[],this.scroller=new h(function(t,e,i){return o._scrollerCallback(t,e,i)},{zooming:!1,animating:!0,bouncing:!1,animationDuration:1e3}),this.scroller.__enableScrollY=!0,this.storyPosition=0;var e=!1;document.addEventListener("touchstart",function(t){o.scroller.doTouchStart(t.touches,t.timeStamp),e=!0},!1),document.addEventListener("touchmove",function(t){e&&(o.scroller.doTouchMove(t.touches,t.timeStamp),e=!0)},!1),document.addEventListener("touchend",function(t){e&&(o.scroller.doTouchEnd(t.timeStamp),e=!1)},!1)}},{key:"_createContainer",value:function(t){var e=this;this.app=new l.Application({backgroundColor:this.backgroundColor,antialias:this.antialias,resolution:1}),this.loader=this.app.loader,this.load=function(){return e.app.loader.load.call(e.app.loader)},this.loader.onComplete.add(function(t){return e.loaded=!0}),(void 0===this.containerSelector?document.body.appendChild(document.createElement("main")):document.querySelector(this.containerSelector)).appendChild(this.app.view),this.containerFitWindow=new l.Container,this.containerFitWindow.pivot.set(0,0),this.containerScroll=new l.Container,this.containerScroll.name="story",this.progressive&&(this.containerScroll.sortableChildren=!0),this.containerFitWindow.addChild(this.containerScroll),this.app.stage.addChild(this.containerFitWindow),this.app.view.style.transformOrigin="0 0"}},{key:"_windowResize",value:function(){var t=this;this.deviceOrientation=this._getDeviceOrientation(),this.deviceWidth="portrait"==this.deviceOrientation?this._clientWidth:this._clientHeight,this.deviceHeight="portrait"==this.deviceOrientation?this._clientHeight:this._clientWidth,this._scalePrev=this._scale,this._scale=this.deviceWidth/this.designWidth,this.maxScroll=this.designLength-this.deviceHeight,this.contentWidth=this.deviceWidth,this.contentLength=this.designLength*this._scale,this.viewWidth=this.designWidth,this.viewLength=this.deviceHeight/this._scale,this.antialias?(this._setContainerRotation(this.containerFitWindow,this.designOrientation,this.deviceOrientation,this.deviceWidth/this._scale),this.app.view.style.transform="scale("+this._scale+")",this.app.renderer.resize(this._clientWidth/this._scale,this._clientHeight/this._scale)):(this._setContainerRotation(this.containerFitWindow,this.designOrientation,this.deviceOrientation,this.deviceWidth),this.containerFitWindow.scale.set(this._scale,this._scale),this.app.renderer.resize(this._clientWidth,this._clientHeight));var e="portrait"==this.deviceOrientation?this.deviceWidth:this.contentLength,i="portrait"==this.deviceOrientation?this.contentLength:this.deviceWidth,o="portrait"!=this.deviceOrientation&&this.scrollPosition/this._scalePrev*this._scale||0,n="portrait"===this.deviceOrientation&&this.scrollPosition/this._scalePrev*this._scale||0;setTimeout(function(){t.scroller.setDimensions(t._clientWidth,t._clientHeight,e,i),t.scroller.scrollTo(o,n,!1)},200)}},{key:"_getDeviceOrientation",value:function(){return a||_?(this._clientWidth=document.documentElement.clientWidth||window.innerWidth,this._clientHeight=document.documentElement.clientHeight||window.innerHeight,180===window.orientation||0===window.orientation?"portrait":90===window.orientation||-90===window.orientation?"landscape":void 0):(this._clientWidth=window.innerWidth||document.documentElement.clientWidth,this._clientHeight=window.innerHeight||document.documentElement.clientHeight,this._clientWidth<this._clientHeight?"portrait":"landscape")}},{key:"_setContainerRotation",value:function(t,e,i,o){o={design_portrait:{device_portrait:{rotation:0,offsetX:0,offsetY:0},device_landscape:{rotation:-Math.PI/2,offsetX:0,offsetY:o}},design_landscape:{device_portrait:{rotation:Math.PI/2,offsetX:o,offsetY:0},device_landscape:{rotation:0,offsetX:0,offsetY:0}}};t.rotation=o["design_"+e]["device_"+i].rotation,t.position.set(o["design_"+e]["device_"+i].offsetX,o["design_"+e]["device_"+i].offsetY)}},{key:"_getSpriteTriggerPosition",value:function(t){var e="x"==this.scrollDirection?t.x:t.y;return t.parent&&"story"!=t.parent.name?e+this._getSpriteTriggerPosition(t.parent):e-2*this.pageHeight/3}},{key:"_getSrollPosition",value:function(t,e){var i,o,n;return(n={design_portrait:{device_portrait:{x:i=t,y:o=e},device_landscape:{x:o,y:i}},design_landscape:{device_portrait:{x:o,y:i},device_landscape:{x:i,y:o}}},function(t,e,i){return n["design_"+t]["device_"+e][i]})(this.designOrientation,this.deviceOrientation,this.scrollDirection)}},{key:"_createSprite",value:function(i){var o=new l.Sprite.from(l.Texture.EMPTY);new l.Loader;return!this.useLoader||this.loaded?o.texture=l.Texture.from(i):this.loader.resources[i]?this.loader.onComplete.add(function(t,e){return o.texture=e[i].texture}):this.loader.add(i,function(t){return o.texture=t.texture}),o}},{key:"_createAnimatedSprite",value:function(i,o){var n,r,e=this,s=new l.AnimatedSprite([l.Texture.EMPTY]);return"object"==u(i)&&0<i.length?(n=[],!this.useLoader||this.loaded?(i.forEach(function(t){n.push(l.Texture.from(t))}),s.textures=n):(i.forEach(function(t){e.loader.resources[t]||e.loader.add(t)}),this.loader.onComplete.add(function(e){i.forEach(function(t){n.push(e.resources[t].texture)}),s.textures=n,!1!==o&&s.play()}))):(r=function(t,e,i){var o,n=[];for(o in e.data.frames){var r=l.Texture.from(o),s=e.data.frames[o].duration;n.push(s?{texture:r,time:s}:r)}t.textures=n,!1!==i&&t.play()},!this.useLoader||this.loaded?(new l.Loader).add(i).load(function(t,e){return r(s,e[i],o)}):this.loader.resources[i]?this.loader.onComplete.add(function(t,e){return r(s,e[i],o)}):this.app.loader.add(i,function(t){return r(s,t,o)})),s}},{key:"_setProps",value:function(t,e){if(e)for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t.zIndex=this.currentZIndex++,t}},{key:"_setChapterChildren",value:function(o){var n=this;o.sprite=function(t,e){return n.sprite(t,e,o)},o.spriteAnimated=function(t,e,i){return n.spriteAnimated(t,e,i,o)},o.graphic=function(t){return n.graphic(t,o)},o.text=function(t,e,i){return n.text(t,e,i,o)},o.chapter=function(t){return n.chapter(t,o)}}},{key:"_setActions",value:function(o){var n=this;o.actionByStep=function(t,e,i){return n.actionByStep(o,t,e,i)},o.setPin=function(t,e){return n.setPin(o,t,e)}}},{key:"_ship",value:function(t,e){var i=this;e?e.addChild(t):this.progressive?(this.nextPool.push(t),this.nextPool.sort(function(t,e){return t[i.scrollDirection]-e[i.scrollDirection]})):this.containerScroll.addChild(t)}},{key:"_createHash",value:function(t){return Array.from(Array(Number(t)||24),function(){return Math.floor(36*Math.random()).toString(36)}).join("")}}])&&n(t.prototype,i),o&&n(t,o),e}()});