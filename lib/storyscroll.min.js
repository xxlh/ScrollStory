/*
 * storyscroll v3.6.0
 * (c) 2019 Little Linghuan & Esone
 * Released under the GPL license
 * ieexx.com
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("pixi.js")):"function"==typeof define&&define.amd?define(["pixi.js"],e):(t=t||self).StoryScroll=e(t.PIXI)}(this,function(l){"use strict";function c(t){return(c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function o(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function n(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function r(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,o)}return i}function s(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?r(i,!0).forEach(function(t){n(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):r(i).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}var e,v,y,i,a,t=navigator.userAgent,_=(navigator.appVersion,t.indexOf("Trident"),t.indexOf("Presto"),t.indexOf("AppleWebKit"),-1<t.indexOf("Gecko")&&t.indexOf("KHTML"),t.match(/AppleWebKit.*Mobile.*/),t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),-1<t.indexOf("Android")||t.indexOf("Adr"),t.indexOf("iPhone"),t.indexOf("iPad"),t.indexOf("Safari"),-1<t.indexOf("MicroMessenger")),h=-1<t.indexOf("Weibo");t.match(/\sQQ/i);e=window,v=Date.now||function(){return+new Date},y={},i=1,e.core?core.effect||(core.effect={}):e.core={effect:{}},core.effect.Animate={requestAnimationFrame:function(){var i=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame,t=!!i;if(i&&!/requestAnimationFrame\(\)\s*\{\s*\[native code\]\s*\}/i.test(i.toString())&&(t=!1),t)return function(t,e){i(t,e)};var o={},n=1,r=null,s=+new Date;return function(t,e){var i=n++;return o[i]=t,null===r&&(r=setInterval(function(){var t=+new Date,e=o;for(var i in o={},e)e.hasOwnProperty(i)&&(e[i](t),s=t);2500<t-s&&(clearInterval(r),r=null)},1e3/60)),i}}(),stop:function(t){var e=null!=y[t];return e&&(y[t]=null),e},isRunning:function(t){return null!=y[t]},start:function(l,a,c,_,h,p){var u=v(),f=u,d=0,g=0,m=i++;if(p=p||document.body,m%20==0){var t={};for(var e in y)t[e]=!0;y=t}return y[m]=!0,core.effect.Animate.requestAnimationFrame(function t(e){var i=!0!==e,o=v();if(!y[m]||a&&!a(m))return y[m]=null,void(c&&c(60-g/((o-u)/1e3),m,!1));if(i)for(var n=Math.round((o-f)/(1e3/60))-1,r=0;r<Math.min(n,4);r++)t(!0),g++;_&&1<(d=(o-u)/_)&&(d=1);var s=h?h(d):d;!1!==l(s,o,i)&&1!==d||!i?i&&(f=o,core.effect.Animate.requestAnimationFrame(t,p)):(y[m]=null,c&&c(60-g/((o-u)/1e3),m,1===d||null==_))},p),m}},function(){function o(){}function p(t){return Math.pow(t-1,3)+1}function u(t){return(t/=.5)<1?.5*Math.pow(t,3):.5*(Math.pow(t-2,3)+2)}var t={__isSingleTouch:!(a=function(t,e){for(var i in this.__callback=t,this.options={scrollingX:!0,scrollingY:!0,animating:!0,animationDuration:250,bouncing:!0,locking:!0,paging:!1,snapping:!1,zooming:!1,minZoom:.5,maxZoom:3,speedMultiplier:1,scrollingComplete:o,penetrationDeceleration:.03,penetrationAcceleration:.08},e)this.options[i]=e[i]}),__isTracking:!1,__didDecelerationComplete:!1,__isGesturing:!1,__isDragging:!1,__isDecelerating:!1,__isAnimating:!1,__clientLeft:0,__clientTop:0,__clientWidth:0,__clientHeight:0,__contentWidth:0,__contentHeight:0,__snapWidth:100,__snapHeight:100,__refreshHeight:null,__refreshActive:!1,__refreshActivate:null,__refreshDeactivate:null,__refreshStart:null,__zoomLevel:1,__scrollLeft:0,__scrollTop:0,__maxScrollLeft:0,__maxScrollTop:0,__scheduledLeft:0,__scheduledTop:0,__scheduledZoom:0,__lastTouchLeft:null,__lastTouchTop:null,__lastTouchMove:null,__positions:null,__minDecelerationScrollLeft:null,__minDecelerationScrollTop:null,__maxDecelerationScrollLeft:null,__maxDecelerationScrollTop:null,__decelerationVelocityX:null,__decelerationVelocityY:null,setDimensions:function(t,e,i,o){var n=this;t===+t&&(n.__clientWidth=t),e===+e&&(n.__clientHeight=e),i===+i&&(n.__contentWidth=i),o===+o&&(n.__contentHeight=o),n.__computeScrollMax(),n.scrollTo(n.__scrollLeft,n.__scrollTop,!0)},setPosition:function(t,e){this.__clientLeft=t||0,this.__clientTop=e||0},setSnapSize:function(t,e){this.__snapWidth=t,this.__snapHeight=e},activatePullToRefresh:function(t,e,i,o){this.__refreshHeight=t,this.__refreshActivate=e,this.__refreshDeactivate=i,this.__refreshStart=o},triggerPullToRefresh:function(){this.__publish(this.__scrollLeft,-this.__refreshHeight,this.__zoomLevel,!0),this.__refreshStart&&this.__refreshStart()},finishPullToRefresh:function(){var t=this;t.__refreshActive=!1,t.__refreshDeactivate&&t.__refreshDeactivate(),t.scrollTo(t.__scrollLeft,t.__scrollTop,!0)},getValues:function(){return{left:this.__scrollLeft,top:this.__scrollTop,zoom:this.__zoomLevel}},getScrollMax:function(){return{left:this.__maxScrollLeft,top:this.__maxScrollTop}},zoomTo:function(t,e,i,o,n){var r=this;if(!r.options.zooming)throw new Error("Zooming is not enabled!");n&&(r.__zoomComplete=n),r.__isDecelerating&&(core.effect.Animate.stop(r.__isDecelerating),r.__isDecelerating=!1);var s=r.__zoomLevel;null==i&&(i=r.__clientWidth/2),null==o&&(o=r.__clientHeight/2),t=Math.max(Math.min(t,r.options.maxZoom),r.options.minZoom),r.__computeScrollMax(t);var l=(i+r.__scrollLeft)*t/s-i,a=(o+r.__scrollTop)*t/s-o;l>r.__maxScrollLeft?l=r.__maxScrollLeft:l<0&&(l=0),a>r.__maxScrollTop?a=r.__maxScrollTop:a<0&&(a=0),r.__publish(l,a,t,e)},zoomBy:function(t,e,i,o,n){this.zoomTo(this.__zoomLevel*t,e,i,o,n)},scrollTo:function(t,e,i,o){var n=this;if(n.__isDecelerating&&(core.effect.Animate.stop(n.__isDecelerating),n.__isDecelerating=!1),null!=o&&o!==n.__zoomLevel){if(!n.options.zooming)throw new Error("Zooming is not enabled!");t*=o,e*=o,n.__computeScrollMax(o)}else o=n.__zoomLevel;n.options.scrollingX?n.options.paging?t=Math.round(t/n.__clientWidth)*n.__clientWidth:n.options.snapping&&(t=Math.round(t/n.__snapWidth)*n.__snapWidth):t=n.__scrollLeft,n.options.scrollingY?n.options.paging?e=Math.round(e/n.__clientHeight)*n.__clientHeight:n.options.snapping&&(e=Math.round(e/n.__snapHeight)*n.__snapHeight):e=n.__scrollTop,t=Math.max(Math.min(n.__maxScrollLeft,t),0),e=Math.max(Math.min(n.__maxScrollTop,e),0),t===n.__scrollLeft&&e===n.__scrollTop&&(i=!1),n.__isTracking||n.__publish(t,e,o,i)},scrollBy:function(t,e,i){var o=this,n=o.__isAnimating?o.__scheduledLeft:o.__scrollLeft,r=o.__isAnimating?o.__scheduledTop:o.__scrollTop;o.scrollTo(n+(t||0),r+(e||0),i)},doMouseZoom:function(t,e,i,o){var n=0<t?.97:1.03;return this.zoomTo(this.__zoomLevel*n,!1,i-this.__clientLeft,o-this.__clientTop)},doTouchStart:function(t,e){if(null==t.length)throw new Error("Invalid touch list: "+t);if(e instanceof Date&&(e=e.valueOf()),"number"!=typeof e)throw new Error("Invalid timestamp value: "+e);var i,o,n=this;n.__interruptedAnimation=!0,n.__isDecelerating&&(core.effect.Animate.stop(n.__isDecelerating),n.__isDecelerating=!1,n.__interruptedAnimation=!0),n.__isAnimating&&(core.effect.Animate.stop(n.__isAnimating),n.__isAnimating=!1,n.__interruptedAnimation=!0);var r=1===t.length;o=r?(i=t[0].pageX,t[0].pageY):(i=Math.abs(t[0].pageX+t[1].pageX)/2,Math.abs(t[0].pageY+t[1].pageY)/2),n.__initialTouchLeft=i,n.__initialTouchTop=o,n.__zoomLevelStart=n.__zoomLevel,n.__lastTouchLeft=i,n.__lastTouchTop=o,n.__lastTouchMove=e,n.__lastScale=1,n.__enableScrollX=!r&&n.options.scrollingX,n.__enableScrollY=!r&&n.options.scrollingY,n.__isTracking=!0,n.__didDecelerationComplete=!1,n.__isDragging=!r,n.__isSingleTouch=r,n.__positions=[]},doTouchMove:function(t,e,i){if(null==t.length)throw new Error("Invalid touch list: "+t);if(e instanceof Date&&(e=e.valueOf()),"number"!=typeof e)throw new Error("Invalid timestamp value: "+e);var o=this;if(o.__isTracking){var n,r;r=2===t.length?(n=Math.abs(t[0].pageX+t[1].pageX)/2,Math.abs(t[0].pageY+t[1].pageY)/2):(n=t[0].pageX,t[0].pageY);var s=o.__positions;if(o.__isDragging){var l=n-o.__lastTouchLeft,a=r-o.__lastTouchTop,c=o.__scrollLeft,_=o.__scrollTop,h=o.__zoomLevel;if(null!=i&&o.options.zooming){var p=h;if(h=h/o.__lastScale*i,p!==(h=Math.max(Math.min(h,o.options.maxZoom),o.options.minZoom))){var u=n-o.__clientLeft,f=r-o.__clientTop;c=(u+c)*h/p-u,_=(f+_)*h/p-f,o.__computeScrollMax(h)}}if(o.__enableScrollX){c-=l*this.options.speedMultiplier;var d=o.__maxScrollLeft;(d<c||c<0)&&(o.options.bouncing?c+=l/2*this.options.speedMultiplier:c=d<c?d:0)}if(o.__enableScrollY){_-=a*this.options.speedMultiplier;var g=o.__maxScrollTop;(g<_||_<0)&&(o.options.bouncing?(_+=a/2*this.options.speedMultiplier,o.__enableScrollX||null==o.__refreshHeight||(!o.__refreshActive&&_<=-o.__refreshHeight?(o.__refreshActive=!0,o.__refreshActivate&&o.__refreshActivate()):o.__refreshActive&&_>-o.__refreshHeight&&(o.__refreshActive=!1,o.__refreshDeactivate&&o.__refreshDeactivate()))):_=g<_?g:0)}60<s.length&&s.splice(0,30),s.push(c,_,e),o.__publish(c,_,h)}else{var m=o.options.locking?3:0,v=Math.abs(n-o.__initialTouchLeft),y=Math.abs(r-o.__initialTouchTop);o.__enableScrollX=o.options.scrollingX&&m<=v,o.__enableScrollY=o.options.scrollingY&&m<=y,s.push(o.__scrollLeft,o.__scrollTop,e),o.__isDragging=(o.__enableScrollX||o.__enableScrollY)&&(5<=v||5<=y),o.__isDragging&&(o.__interruptedAnimation=!1)}o.__lastTouchLeft=n,o.__lastTouchTop=r,o.__lastTouchMove=e,o.__lastScale=i}},doTouchEnd:function(t){if(t instanceof Date&&(t=t.valueOf()),"number"!=typeof t)throw new Error("Invalid timestamp value: "+t);var e=this;if(e.__isTracking){if(e.__isTracking=!1,e.__isDragging)if(e.__isDragging=!1,e.__isSingleTouch&&e.options.animating&&t-e.__lastTouchMove<=100){for(var i=e.__positions,o=i.length-1,n=o,r=o;0<r&&i[r]>e.__lastTouchMove-100;r-=3)n=r;if(n!==o){var s=i[o]-i[n],l=e.__scrollLeft-i[n-2],a=e.__scrollTop-i[n-1];e.__decelerationVelocityX=l/s*(1e3/60),e.__decelerationVelocityY=a/s*(1e3/60);var c=e.options.paging||e.options.snapping?4:1;Math.abs(e.__decelerationVelocityX)>c||Math.abs(e.__decelerationVelocityY)>c?e.__refreshActive||e.__startDeceleration(t):e.options.scrollingComplete()}else e.options.scrollingComplete()}else 100<t-e.__lastTouchMove&&e.options.scrollingComplete();e.__isDecelerating||(e.__refreshActive&&e.__refreshStart?(e.__publish(e.__scrollLeft,-e.__refreshHeight,e.__zoomLevel,!0),e.__refreshStart&&e.__refreshStart()):((e.__interruptedAnimation||e.__isDragging)&&e.options.scrollingComplete(),e.scrollTo(e.__scrollLeft,e.__scrollTop,!0,e.__zoomLevel),e.__refreshActive&&(e.__refreshActive=!1,e.__refreshDeactivate&&e.__refreshDeactivate()))),e.__positions.length=0}},__publish:function(t,e,i,o){var n=this,r=n.__isAnimating;if(r&&(core.effect.Animate.stop(r),n.__isAnimating=!1),o&&n.options.animating){n.__scheduledLeft=t,n.__scheduledTop=e,n.__scheduledZoom=i;var s=n.__scrollLeft,l=n.__scrollTop,a=n.__zoomLevel,c=t-s,_=e-l,h=i-a;n.__isAnimating=core.effect.Animate.start(function(t,e,i){i&&(n.__scrollLeft=s+c*t,n.__scrollTop=l+_*t,n.__zoomLevel=a+h*t,n.__callback&&n.__callback(n.__scrollLeft,n.__scrollTop,n.__zoomLevel))},function(t){return n.__isAnimating===t},function(t,e,i){e===n.__isAnimating&&(n.__isAnimating=!1),(n.__didDecelerationComplete||i)&&n.options.scrollingComplete(),n.options.zooming&&(n.__computeScrollMax(),n.__zoomComplete&&(n.__zoomComplete(),n.__zoomComplete=null))},n.options.animationDuration,r?p:u)}else n.__scheduledLeft=n.__scrollLeft=t,n.__scheduledTop=n.__scrollTop=e,n.__scheduledZoom=n.__zoomLevel=i,n.__callback&&n.__callback(t,e,i),n.options.zooming&&(n.__computeScrollMax(),n.__zoomComplete&&(n.__zoomComplete(),n.__zoomComplete=null))},__computeScrollMax:function(t){var e=this;null==t&&(t=e.__zoomLevel),e.__maxScrollLeft=Math.max(e.__contentWidth*t-e.__clientWidth,0),e.__maxScrollTop=Math.max(e.__contentHeight*t-e.__clientHeight,0)},__startDeceleration:function(t){var o=this;if(o.options.paging){var e=Math.max(Math.min(o.__scrollLeft,o.__maxScrollLeft),0),i=Math.max(Math.min(o.__scrollTop,o.__maxScrollTop),0),n=o.__clientWidth,r=o.__clientHeight;o.__minDecelerationScrollLeft=Math.floor(e/n)*n,o.__minDecelerationScrollTop=Math.floor(i/r)*r,o.__maxDecelerationScrollLeft=Math.ceil(e/n)*n,o.__maxDecelerationScrollTop=Math.ceil(i/r)*r}else o.__minDecelerationScrollLeft=0,o.__minDecelerationScrollTop=0,o.__maxDecelerationScrollLeft=o.__maxScrollLeft,o.__maxDecelerationScrollTop=o.__maxScrollTop;var s=o.options.snapping?4:.001;o.__isDecelerating=core.effect.Animate.start(function(t,e,i){o.__stepThroughDeceleration(i)},function(){var t=Math.abs(o.__decelerationVelocityX)>=s||Math.abs(o.__decelerationVelocityY)>=s;return t||(o.__didDecelerationComplete=!0),t},function(t,e,i){o.__isDecelerating=!1,o.__didDecelerationComplete&&o.options.scrollingComplete(),o.scrollTo(o.__scrollLeft,o.__scrollTop,o.options.snapping)})},__stepThroughDeceleration:function(t){var e=this,i=e.__scrollLeft+e.__decelerationVelocityX,o=e.__scrollTop+e.__decelerationVelocityY;if(!e.options.bouncing){var n=Math.max(Math.min(e.__maxDecelerationScrollLeft,i),e.__minDecelerationScrollLeft);n!==i&&(i=n,e.__decelerationVelocityX=0);var r=Math.max(Math.min(e.__maxDecelerationScrollTop,o),e.__minDecelerationScrollTop);r!==o&&(o=r,e.__decelerationVelocityY=0)}if(t?e.__publish(i,o,e.__zoomLevel):(e.__scrollLeft=i,e.__scrollTop=o),!e.options.paging){e.__decelerationVelocityX*=.95,e.__decelerationVelocityY*=.95}if(e.options.bouncing){var s=0,l=0,a=e.options.penetrationDeceleration,c=e.options.penetrationAcceleration;i<e.__minDecelerationScrollLeft?s=e.__minDecelerationScrollLeft-i:i>e.__maxDecelerationScrollLeft&&(s=e.__maxDecelerationScrollLeft-i),o<e.__minDecelerationScrollTop?l=e.__minDecelerationScrollTop-o:o>e.__maxDecelerationScrollTop&&(l=e.__maxDecelerationScrollTop-o),0!==s&&(s*e.__decelerationVelocityX<=0?e.__decelerationVelocityX+=s*a:e.__decelerationVelocityX=s*c),0!==l&&(l*e.__decelerationVelocityY<=0?e.__decelerationVelocityY+=l*a:e.__decelerationVelocityY=l*c)}}};for(var e in t)a.prototype[e]=t[e]}();var p=a;return function(){function e(t){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),n(this,"STAGE_BOUNDARY",3),n(this,"designWidth",void 0),n(this,"designLength",void 0),n(this,"contentWidth",void 0),n(this,"contentLength",void 0),n(this,"viewWidth",void 0),n(this,"viewLength",void 0),n(this,"deviceWidth",void 0),n(this,"deviceHeight",void 0),n(this,"maxScroll",1e4),n(this,"storyPosition",0),n(this,"prevPool",[]),n(this,"stagePool",[]),n(this,"stagePoolByLen",[]),n(this,"stageZIndexes",{}),n(this,"nextPool",[]),n(this,"currentZIndex",0),this._defaultSetting(t||{}),this._createContainer(t),this._windowResize(),window.addEventListener("resize",this._windowResize.bind(this),!1)}return function(t,e,i){e&&o(t.prototype,e),i&&o(t,i)}(e,[{key:"chapter",value:function(t,e){var i=new l.Container;return this._setProps(i,t),this._setChapterChildren(i),this._setActions(i),this._ship(i,e),i}},{key:"sprite",value:function(t,e,i){var o=this._createSprite(t);return this._setProps(o,e),this._setActions(o),this._ship(o,i),o}},{key:"spriteAnimated",value:function(t,e,i,o){var n=this._createAnimatedSprite(t,i);return this._setProps(n,e),this._setActions(n),this._ship(n,o),!1!==i&&n.play(),n}},{key:"graphic",value:function(t,e){var i=new l.Graphics;return this._setProps(i,t),this._setActions(i),this._ship(i,e),i}},{key:"text",value:function(t,e,i,o){var n=new l.TextStyle;this._setProps(n,i);var r=new l.Text(t,n);return this._setProps(r,e),this._setActions(r),this._ship(r,o),r}},{key:"actionByStep",value:function(t,e,i,o){void 0===o&&(o=this._getSpriteTriggerPosition(t)),t.actions||(t.actions={});var n=this._createHash(8);return t.actions[n]={action:{type:"section",props:e,section:i,triggerPosition:o}},this.sectionActions.push(s({sprite:t,hash:n},t.actions[n].action)),t}},{key:"setPin",value:function(t,e,i){t.actions||(t.actions={}),i=i||this.maxScroll+this.viewLength-t[this.scrollDirection],t.pinSection=i;var o=this._createHash(8);return t.actions[o]={action:{type:"pin",section:i,triggerPosition:e}},this.pinActions.push(s({sprite:t,hash:o},t.actions[o].action)),t}},{key:"stop",value:function(){this.scroller.options.scrollingX=!1,this.scroller.options.scrollingY=!1}},{key:"play",value:function(){this.scroller.options.scrollingX=!0,this.scroller.options.scrollingY=!0}},{key:"_scrollerCallback",value:function(t,e,i){var o=this,n=this;function r(t){var e=t[n.scrollDirection?"width":"height"];return t.pinSection&&(e+=t.pinSection),e}function s(t){t.tweens&&t.tweens.forEach(function(t){t.pausedAtLeaving=t.paused(),t.pausedAtLeaving||t.pause()})}function l(t){t.tweens&&t.tweens.forEach(function(t){t.pausedAtLeaving||t.play()})}function a(t){return!!n.stageZIndexes[t.zIndex]}this.scrollPosition=this._getSrollPosition(t,e),this.storyPosition=this.scrollPosition/this._scale,"y"==this.scrollDirection?this.containerScroll.y=-this.storyPosition:this.containerScroll.x=-this.storyPosition,function t(){var i=this;if(0==this.nextPool.length)return;if(this.nextPool[0][this.scrollDirection]<this.storyPosition+this.viewLength+(this.STAGE_BOUNDARY-1)/2*this.viewLength){var e=this.nextPool.shift();this.containerScroll.addChild(e),this.stageZIndexes[e.zIndex]=!0,this.stagePool.push(e),this.stagePoolByLen.push(e),this.stagePoolByLen.sort(function(t,e){return t[i.scrollDirection]+t[i.scrollDirection?"width":"height"]-(e[i.scrollDirection]+e[i.scrollDirection?"width":"height"])}),l(e),t.call(this)}}.call(this),function t(){i(this.stagePoolByLen);if(0==this.stagePoolByLen.length)return;if(this.stagePoolByLen[0][this.scrollDirection]+r(this.stagePoolByLen[0])<this.storyPosition-(this.STAGE_BOUNDARY-1)/2*this.viewLength){var e=this.stagePoolByLen.shift();this.containerScroll.removeChild(e),delete this.stageZIndexes[e.zIndex],this.prevPool.push(e),s(e),t.call(this)}function i(t){0!=t.length&&(a(t[0])||(t.shift(),i(t)))}}.call(this),function t(){var i=this;if(0==this.prevPool.length)return;if(this.prevPool[this.prevPool.length-1][this.scrollDirection]+r(this.prevPool[this.prevPool.length-1])>this.storyPosition-(this.STAGE_BOUNDARY-1)/2*this.viewLength){var e=this.prevPool.pop();this.containerScroll.addChild(e),this.stageZIndexes[e.zIndex]=!0,this.stagePoolByLen.unshift(e),this.stagePool.unshift(e),this.stagePool.sort(function(t,e){return t[i.scrollDirection]-e[i.scrollDirection]}),l(e),t.call(this)}}.call(this),function t(){i(this.stagePool);if(0==this.stagePool.length)return;if(this.stagePool[this.stagePool.length-1][this.scrollDirection]>this.storyPosition+this.viewLength+(this.STAGE_BOUNDARY-1)/2*this.viewLength){var e=this.stagePool.pop();this.containerScroll.removeChild(e),delete this.stageZIndexes[e.zIndex],this.nextPool.unshift(e),s(e),t.call(this)}function i(t){0!=t.length&&(a(t[t.length-1])||(t.shift(),i(t)))}}.call(this),this.sectionActions.forEach(function(t){(function(t){if(t.sprite._destroyed)return;if(!a(t.sprite))return;var e=t.sprite.actions[t.hash];t.triggerPosition<=this.storyPosition&&this.storyPosition<t.triggerPosition+t.section?i("during",e,t,this.storyPosition):this.storyPosition>=t.triggerPosition+t.section?i("after",e,t,this.storyPosition):this.storyPosition<t.triggerPosition&&i("before",e,t,this.storyPosition);function s(t,e,i,o,n){return o+(i-t)/(e-t)*(n-o)}function i(t,e,i,o){for(var n in t=t||"before",e.originProps=e.originProps||{},i.props)if("object"==c(i.props[n]))for(var r in i.props[n])void 0===e.originProps[n]&&(e.originProps[n]={}),void 0===e.originProps[n][r]&&(e.originProps[n][r]=i.sprite[n][r]),i.sprite[n][r]="before"==t?e.originProps[n][r]:"after"==t?i.props[n][r]:s(i.triggerPosition,i.triggerPosition+i.section,o,e.originProps[n][r],i.props[n][r]);else void 0===e.originProps[n]&&(e.originProps[n]=i.sprite[n]),i.sprite[n]="before"==t?e.originProps[n]:"after"==t?i.props[n]:s(i.triggerPosition,i.triggerPosition+i.section,o,e.originProps[n],i.props[n])}}).call(o,t)}),this.pinActions.forEach(function(t){(function(t){if(t.sprite._destroyed)return;if(!a(t.sprite))return;var e=t.sprite.actions[t.hash];e.originProps=e.originProps||{},void 0===e.originProps[this.scrollDirection]&&(e.originProps[this.scrollDirection]=t.sprite[this.scrollDirection]);t.sprite[this.scrollDirection]=e.originProps[this.scrollDirection]-t.triggerPosition+this.storyPosition}).call(o,t)}),this.debug&&("all"==this.debug&&(console.log("top:",e),console.log("left:",t)),console.log("scrollPosition :",this.scrollPosition))}},{key:"_defaultSetting",value:function(t){var o=this;this.scrollDirection=t.direction||"y",this.designWidth=t.width||750,this.designLength=t.length||1e4,this.containerSelector=t.container,this.backgroundColor=t.bgcolor,this.useLoader=t.loader||!1,this.progressive=t.progressive||!1,this.antialias=t.antialias||!1,this.debug=t.debug||!1,this._clientWidth=window.innerWidth||document.documentElement.clientWidth,this._clientHeight=window.innerHeight||document.documentElement.clientHeight,this.designOrientation="y"==this.scrollDirection?"portrait":"landscape",this.pinActions=[],this.sectionActions=[],this.loaderList=[],this.scroller=new p(function(t,e,i){return o._scrollerCallback(t,e,i)},{zooming:!1,animating:!0,bouncing:!1,animationDuration:1e3}),this.scroller.__enableScrollY=!0,this.storyPosition=0;var e=!1;document.addEventListener("touchstart",function(t){o.scroller.doTouchStart(t.touches,t.timeStamp),e=!0},!1),document.addEventListener("touchmove",function(t){e&&(o.scroller.doTouchMove(t.touches,t.timeStamp),e=!0)},!1),document.addEventListener("touchend",function(t){e&&(o.scroller.doTouchEnd(t.timeStamp),e=!1)},!1)}},{key:"_createContainer",value:function(t){var e=this;(this.app=new l.Application({backgroundColor:this.backgroundColor,antialias:this.antialias,resolution:1}),this.loader=this.app.loader,this.load=function(){return e.app.loader.load.call(e.app.loader)},this.loader.on("complete",function(t){return e.useLoader=!1}),void 0===this.containerSelector)?document.body.appendChild(document.createElement("main")).appendChild(this.app.view):document.querySelector(this.containerSelector).appendChild(this.app.view);this.containerFitWindow=new l.Container,this.containerFitWindow.pivot.set(0,0),this.containerScroll=new l.Container,this.containerScroll.name="story",this.progressive&&(this.containerScroll.sortableChildren=!0),this.containerFitWindow.addChild(this.containerScroll),this.app.stage.addChild(this.containerFitWindow),this.app.view.style.transformOrigin="0 0"}},{key:"_windowResize",value:function(){var t=this;this.deviceOrientation=this._getDeviceOrientation(),this.deviceWidth="portrait"==this.deviceOrientation?this._clientWidth:this._clientHeight,this.deviceHeight="portrait"==this.deviceOrientation?this._clientHeight:this._clientWidth,this._scalePrev=this._scale,this._scale=this.deviceWidth/this.designWidth,this.maxScroll=this.designLength-this.deviceHeight,this.contentWidth=this.deviceWidth,this.contentLength=this.designLength*this._scale,this.viewWidth=this.designWidth,this.viewLength=this.deviceHeight/this._scale,this.antialias?(this._setContainerRotation(this.containerFitWindow,this.designOrientation,this.deviceOrientation,this.deviceWidth/this._scale),this.app.view.style.transform="scale("+this._scale+")",this.app.renderer.resize(this._clientWidth/this._scale,this._clientHeight/this._scale)):(this._setContainerRotation(this.containerFitWindow,this.designOrientation,this.deviceOrientation,this.deviceWidth),this.containerFitWindow.scale.set(this._scale,this._scale),this.app.renderer.resize(this._clientWidth,this._clientHeight));var e="portrait"==this.deviceOrientation?this.deviceWidth:this.contentLength,i="portrait"==this.deviceOrientation?this.contentLength:this.deviceWidth,o="portrait"==this.deviceOrientation?0:this.scrollPosition/this._scalePrev*this._scale||0,n="portrait"!==this.deviceOrientation?0:this.scrollPosition/this._scalePrev*this._scale||0;setTimeout(function(){t.scroller.setDimensions(t._clientWidth,t._clientHeight,e,i),t.scroller.scrollTo(o,n,!1)},200)}},{key:"_getDeviceOrientation",value:function(){if(_){if(this._clientWidth=document.documentElement.clientWidth||window.innerWidth,this._clientHeight=document.documentElement.clientHeight||window.innerHeight,180===window.orientation||0===window.orientation)return"portrait";if(90===window.orientation||-90===window.orientation)return"landscape"}else{if(!h)return this._clientWidth=window.innerWidth||document.documentElement.clientWidth,this._clientHeight=window.innerHeight||document.documentElement.clientHeight,this._clientWidth<this._clientHeight?"portrait":"landscape";if(this._clientWidth=document.documentElement.clientWidth||window.innerWidth,this._clientHeight=document.documentElement.clientHeight||window.innerHeight,180===window.orientation||0===window.orientation)return"portrait";if(90===window.orientation||-90===window.orientation)return"landscape"}}},{key:"_setContainerRotation",value:function(t,e,i,o){var n={design_portrait:{device_portrait:{rotation:0,offsetX:0,offsetY:0},device_landscape:{rotation:-Math.PI/2,offsetX:0,offsetY:o}},design_landscape:{device_portrait:{rotation:Math.PI/2,offsetX:o,offsetY:0},device_landscape:{rotation:0,offsetX:0,offsetY:0}}};t.rotation=n["design_"+e]["device_"+i].rotation,t.position.set(n["design_"+e]["device_"+i].offsetX,n["design_"+e]["device_"+i].offsetY)}},{key:"_getSpriteTriggerPosition",value:function(t){var e="x"==this.scrollDirection?t.x:t.y;return t.parent&&"story"!=t.parent.name?e+this._getSpriteTriggerPosition(t.parent):e-2*this.pageHeight/3}},{key:"_getSrollPosition",value:function(t,e){var i,o,n;return(n={design_portrait:{device_portrait:{x:i=t,y:o=e},device_landscape:{x:o,y:i}},design_landscape:{device_portrait:{x:o,y:i},device_landscape:{x:i,y:o}}},function(t,e,i){return n["design_"+t]["device_"+e][i]})(this.designOrientation,this.deviceOrientation,this.scrollDirection)}},{key:"_createSprite",value:function(i){var o=new l.Sprite.from(l.Texture.EMPTY);new l.Loader;return this.useLoader?this.loader.resources[i]?this.loader.on("complete",function(t,e){return o.texture=e[i].texture}):this.loader.add(i,function(t){return o.texture=t.texture}):o.texture=l.Texture.from(i),o}},{key:"_createAnimatedSprite",value:function(i,o){var e=this,n=new l.AnimatedSprite([l.Texture.EMPTY]);if("object"==c(i)&&0<i.length){var r=[];this.useLoader?(i.forEach(function(t){e.loader.resources[t]||e.loader.add(t)}),this.loader.on("complete",function(e){i.forEach(function(t){r.push(e.resources[t].texture)}),n.textures=r,!1!==o&&n.play()})):(i.forEach(function(t){r.push(l.Texture.from(t))}),n.textures=r)}else{var s=function(t,e,i){var o=[];for(var n in e.data.frames){var r=l.Texture.from(n),s=e.data.frames[n].duration;o.push(s?{texture:r,time:s}:r)}t.textures=o,!1!==i&&t.play()};if(this.useLoader)this.loader.resources[i]?this.loader.on("complete",function(t,e){return s(n,e[i],o)}):this.app.loader.add(i,function(t){return s(n,t,o)});else(new l.Loader).add(i).load(function(t,e){return s(n,e[i],o)})}return n}},{key:"_setProps",value:function(t,e){if(e)for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t.zIndex=this.currentZIndex++,t}},{key:"_setChapterChildren",value:function(o){var n=this;o.sprite=function(t,e){return n.sprite(t,e,o)},o.spriteAnimated=function(t,e,i){return n.spriteAnimated(t,e,i,o)},o.graphic=function(t){return n.graphic(t,o)},o.text=function(t,e,i){return n.text(t,e,i,o)},o.chapter=function(t){return n.chapter(t,o)}}},{key:"_setActions",value:function(o){var n=this;o.actionByStep=function(t,e,i){return n.actionByStep(o,t,e,i)},o.setPin=function(t,e){return n.setPin(o,t,e)}}},{key:"_ship",value:function(t,e){var i=this;e?e.addChild(t):this.progressive?(this.nextPool.push(t),this.nextPool.sort(function(t,e){return t[i.scrollDirection]-e[i.scrollDirection]})):this.containerScroll.addChild(t)}},{key:"_createHash",value:function(t){return Array.from(Array(Number(t)||24),function(){return Math.floor(36*Math.random()).toString(36)}).join("")}}]),e}()});